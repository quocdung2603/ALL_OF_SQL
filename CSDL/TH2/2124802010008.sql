CREATE DATABASE QLDA
GO

USE QLDA
GO

CREATE TABLE PHONGBAN
(
	MAPHG INT PRIMARY KEY,
	TENPHG CHAR(10) NOT NULL,
	TRPHG CHAR(3),
	NG_NHANCHUC DATETIME,
)

CREATE TABLE NHANVIEN
(
	MANV CHAR(3) PRIMARY KEY,
	HONV CHAR(20) NOT NULL,
	TENLOT CHAR(20),
	TENNV CHAR(20) NOT NULL,
	NGSINH DATETIME,
	PHAI CHAR(3),
	DCHI CHAR(100),
	MA_NQL CHAR(3),
	PHG INT FOREIGN KEY(PHG) REFERENCES PHONGBAN(MAPHG),
	LUONG FLOAT,
)

CREATE TABLE DEAN
(
	MADA INT PRIMARY KEY,
	TENDA CHAR(30) NOT NULL,
	DDIEM_DA CHAR(100) NOT NULL,
	PHONG INT FOREIGN KEY (PHONG) REFERENCES PHONGBAN(MAPHG),
)

CREATE TABLE PHANCONG
(
	MA_NVIEN CHAR(3) FOREIGN KEY(MA_NVIEN) REFERENCES NHANVIEN(MANV),
	SODA INT FOREIGN KEY(SODA) REFERENCES DEAN(MADA),
	THOIGIAN FLOAT,	
	PRIMARY KEY (MA_NVIEN,SODA)
)

CREATE TABLE DIADIEM_PHG
(
	MAPHG INT FOREIGN KEY (MAPHG) REFERENCES PHONGBAN(MAPHG),
	DIADIEM CHAR(30),
	PRIMARY KEY(MAPHG,DIADIEM),
)

CREATE TABLE THANNHAN
(
	MA_NVIEN CHAR(3) FOREIGN KEY(MA_NVIEN) REFERENCES NHANVIEN(MANV),
	TENTN CHAR(50),
	PHAI CHAR(5),
	NGSINH DATETIME,
	QUANHE CHAR(30),
	PRIMARY KEY( MA_NVIEN , TENTN),
)

INSERT INTO PHONGBAN
VALUES( 1,'QUAN LY', '888', '06/19/1971')
INSERT INTO PHONGBAN
VALUES(4,'DIEU HANH', '777', '01/01/1985')
INSERT INTO PHONGBAN
VALUES(5,'NGHIEN CUU', '333', '05/22/1978')

INSERT INTO NHANVIEN
VALUES('123','Dinh','Ba' , 'Tien' , '01/09/1955','Nam','731 Tran Hung Dao Q1','333',5 ,30000)
INSERT INTO NHANVIEN
VALUES('333','Nguyen','Thanh' , 'Tung' , '12/08/1945','Nam','638 Nguyen Van Cu Q5','888',5 ,40000)
INSERT INTO NHANVIEN
VALUES('453','Tran','Thanh' , 'Tam' , '07/31/1962','Nam','543 Mai Thi Luu Ba Dinh Ha','333',5 ,25000)
INSERT INTO NHANVIEN
VALUES('666','Nguyen','Manh' , 'Hung' , '09/015/1952','Nam','975 Le Lai P3 Vung Tau','333',5 ,38000)
INSERT INTO NHANVIEN
VALUES('888','Vuong','Ngoc' , 'Quyen' , '10/10/1927','Nu','450 Trung Vuong My Tho TG',' ',1 ,55000)
INSERT INTO NHANVIEN
VALUES('987','Le','Thi' , 'Nhan' , '06/20/1931','Nu','291 Ho Van Hue Q.PN','888',4 ,43000)
INSERT INTO NHANVIEN
VALUES('777','Tran','Hong' , 'Quang' , '03/29/1959','Nam','980 Le Hong Phuong Vung Tau','987',4 ,25000)
INSERT INTO NHANVIEN
VALUES('999','Bui','Thuy' , 'Vu' , '07/19/1958','Nam','332 Nguyen Thai Hoc Quy','987',4 ,25000)
SELECT * FROM NHANVIEN

DELETE  FROM NHANVIEN
DELETE  FROM THANNHAN

INSERT INTO THANNHAN
VALUES ('123','Chau' ,'Nu','12/31/1978','Con gai')
INSERT INTO THANNHAN
VALUES ('123','Duy' ,'Nam','01/01/1978','Con trai')
INSERT INTO THANNHAN
VALUES ('123','Phuong' ,'Nu','05/05/1957','Vo chong')
INSERT INTO THANNHAN
VALUES ('333','Duong' ,'Nu','05/03/1937','Vo chong')
INSERT INTO THANNHAN
VALUES ('333','Tung' ,'Nam','10/25/1973','Con trai')
INSERT INTO THANNHAN
VALUES ('333','Quang' ,'Nu','04/05/1976','Con gai')
INSERT INTO THANNHAN
VALUES ('987','Dang' ,'Nam','02/29/1932','Vo chong')
SELECT * FROM THANNHAN

INSERT INTO DEAN
VALUES (1,'San phan X','VUNG TAU',5)
INSERT INTO DEAN
VALUES (2,'San phan Y','NHA TRANG',5)
INSERT INTO DEAN
VALUES (3,'San phan Z','TP HCM',5)
INSERT INTO DEAN
VALUES (10,'Tin hoc hoa','HA NOI',4)
INSERT INTO DEAN
VALUES (20,'Cap quang','TP HCM',1)
INSERT INTO DEAN
VALUES (30,'Dao tao','HA NOI',4)
SELECT * FROM DEAN

INSERT INTO PHANCONG
VALUES ('123',1,22.5)
INSERT INTO PHANCONG
VALUES ('123',2,7.5)
INSERT INTO PHANCONG
VALUES ('123',3,10)
INSERT INTO PHANCONG
VALUES ('333',10,10)
INSERT INTO PHANCONG
VALUES ('333',20,10)
INSERT INTO PHANCONG
VALUES ('453',1,20)
INSERT INTO PHANCONG
VALUES ('453',2,20)
INSERT INTO PHANCONG
VALUES ('666',3,40)
INSERT INTO PHANCONG
VALUES ('888',20,0)
INSERT INTO PHANCONG
VALUES ('987',20,15)
SELECT * FROM PHANCONG

INSERT INTO DIADIEM_PHG
VALUES (1,'TP HCM')
INSERT INTO DIADIEM_PHG
VALUES (4,'HA NOI')
INSERT INTO DIADIEM_PHG
VALUES (5,'NHA TRANG')
INSERT INTO DIADIEM_PHG
VALUES (5,'TP HCM')
INSERT INTO DIADIEM_PHG
VALUES (5,'VUNG TAU')
SELECT * FROM DIADIEM_PHG

/*CAU1*/
SELECT * 
FROM NHANVIEN
WHERE PHG = 4

/*CAU2*/
SELECT *
FROM NHANVIEN
WHERE LUONG>30000

/*CAU3*/
SELECT *
FROM NHANVIEN
WHERE LUONG>25000 AND PHG=4 OR LUONG>30000 AND PHG=5

/*CAU 4*/
SELECT HONV,TENLOT,TENNV
FROM NHANVIEN,DIADIEM_PHG
WHERE DIADIEM ='TP HCM' AND MAPHG=PHG
/*CAU5*/
SELECT HONV,TENLOT,TENNV
FROM NHANVIEN
WHERE HONV LIKE 'N%'
/*CAU6*/
SELECT NGSINH,DCHI
FROM NHANVIEN
WHERE HONV LIKE 'Dinh' AND TENLOT LIKE 'Ba' AND TENNV LIKE 'Tien'
/*CAU7*/
SELECT *
FROM NHANVIEN
WHERE YEAR(NGSINH) BETWEEN 1960 AND 1965
/*CAU8*/
SELECT HONV,TENLOT,TENNV,YEAR(NGSINH)
FROM NHANVIEN
/*CAU9*/
SELECT HONV,TENLOT,TENNV,(2022-YEAR(NGSINH))AS TUOINV
FROM NHANVIEN
/*c10*/
SELECT TENPHG, DIADIEM
FROM PHONGBAN PB, DIADIEM_PHG DD
WHERE PB.MAPHG = DD.MAPHG
/*c11*/
SELECT HONV,TENLOT,TENNV , TENPHG
FROM NHANVIEN NV , PHONGBAN PB
WHERE NV.MANV = PB.TRPHG
/*c12*/
SELECT HONV,TENLOT,TENNV,DCHI,TENPHG
FROM NHANVIEN NV , PHONGBAN PB
WHERE NV.PHG = PB.MAPHG AND PB.MAPHG=5
/*c13*/
SELECT TENDA,TENPHG,HONV,TENLOT,TENNV,NG_NHANCHUC
FROM NHANVIEN NV, PHONGBAN PB, DEAN DA
WHERE DA.DDIEM_DA='HA NOI' AND DA.PHONG=PB.MAPHG AND NV.MANV=PB.TRPHG
/*c14*/
SELECT HONV, TENLOT,TENNV,TENTN,QUANHE
FROM NHANVIEN NV, THANNHAN TN
WHERE NV.MANV = TN.MA_NVIEN AND NV.PHAI='Nu'
/*c15*/
SELECT NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV AS HOTENNV,QL.HONV+' '+ QL.TENLOT+' '+QL.TENNV AS HOTENNQL
FROM NHANVIEN NV, NHANVIEN QL
WHERE NV.MA_NQL=QL.MANV
/*c16*/
SELECT NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV AS HOTENNV,TP.HONV+' '+ TP.TENLOT+' '+TP.TENNV AS HOTENTRPHG
FROM NHANVIEN NV, NHANVIEN TP, PHONGBAN PB
WHERE NV.PHG = PB.MAPHG AND TP.MANV=PB.TRPHG
--17
SELECT HONV,TENLOT,TENNV
FROM NHANVIEN , DEAN
WHERE PHG=PHONG AND TENDA='San phan X' AND MA_NQL='333'
--18
SELECT TENDA
FROM NHANVIEN NV, DEAN DA
WHERE NV.HONV='Dinh' AND NV.TENLOT='Ba' AND NV.TENNV='Tien' AND NV.PHG=DA.PHONG
--19
SELECT COUNT(*)
FROM DEAN
--20
SELECT COUNT(*)
FROM PHONGBAN PB , DEAN DA
WHERE PB.MAPHG = DA.PHONG AND DA.PHONG=5
--21
SELECT AVG(LUONG) AS LUONG_TRUNG_BINH
FROM NHANVIEN
WHERE PHAI='Nu'
--22
SELECT COUNT(MA_NVIEN) AS SL_THAN_NHAN
FROM THANNHAN
WHERE MA_NVIEN='123'
--23
SELECT TENDA ,SUM(THOIGIAN) AS TONGTHOIGIAN
FROM PHANCONG PC, DEAN DA
WHERE PC.SODA = DA.MADA
GROUP BY DA.TENDA
--24
SELECT TENDA, COUNT(*) AS SLNV
FROM PHANCONG PC, NHANVIEN NV , DEAN DA
WHERE PC.MA_NVIEN=NV.MANV AND PC.SODA=DA.MADA
GROUP BY TENDA
--25
SELECT NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV AS HOTENNV , COUNT(*) AS SLTN
FROM NHANVIEN NV, THANNHAN TN
WHERE NV.MANV= TN.MA_NVIEN
GROUP BY NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV
--26
SELECT NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV AS HOTENNV, COUNT(*) AS SLDA
FROM NHANVIEN NV , PHANCONG PC
WHERE NV.MANV=PC.MA_NVIEN
GROUP BY NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV
--27
SELECT QL.HONV+' '+ QL.TENLOT+' '+ QL.TENNV AS HOTENNQL, COUNT(*) SLNV
FROM NHANVIEN NV, NHANVIEN QL
WHERE NV.MA_NQL= QL.MANV
GROUP BY QL.HONV+' '+ QL.TENLOT+' '+ QL.TENNV
--28
SELECT PB.TENPHG , AVG(LUONG) AS LUONGTRUNGBINH
FROM NHANVIEN NV , PHONGBAN PB
WHERE NV.PHG = PB.MAPHG
GROUP BY TENPHG
--29
SELECT PB.TENPHG , COUNT(NV.MANV) AS SLNV
FROM NHANVIEN NV, PHONGBAN PB
WHERE NV.PHG=PB.MAPHG
GROUP BY PB.TENPHG
HAVING AVG(NV.LUONG)>30000
--30
SELECT PB.TENPHG , COUNT(*) AS SLDA
FROM PHONGBAN PB, DEAN DA
WHERE PB.MAPHG = DA.PHONG
GROUP BY PB.TENPHG
--31
SELECT PB.TENPHG, TP.HONV+' '+ TP.TENLOT+' '+TP.TENNV AS HOTENTRPHG , COUNT(*) AS SLDA
FROM PHONGBAN PB, DEAN DA, NHANVIEN TP
WHERE TP.MANV=PB.TRPHG AND PB.MAPHG=DA.PHONG
GROUP BY PB.TENPHG, TP.HONV+' '+ TP.TENLOT+' '+TP.TENNV 
--32
SELECT PB.TENPHG, COUNT(*) AS SLDA
FROM PHONGBAN PB, DEAN DA, NHANVIEN NV
WHERE PB.MAPHG=DA.PHONG AND NV.PHG=PB.MAPHG
GROUP BY PB.TENPHG
HAVING AVG(NV.LUONG)>40000
--33
SELECT DD.DIADIEM , COUNT(*) AS SLDA
FROM DEAN DA, DIADIEM_PHG DD
WHERE DD.MAPHG=DA.PHONG
GROUP BY DD.DIADIEM
--34
SELECT DA.TENDA , SUM(PC.THOIGIAN) AS TONGTHOIGIAN
FROM DEAN DA, PHANCONG PC 
WHERE DA.MADA=PC.SODA
GROUP BY DA.TENDA
--35
SELECT DA.TENDA , COUNT(*) AS SLNV
FROM DEAN DA , NHANVIEN NV
WHERE DA.TENDA='Dao tao' AND NV.PHG=DA.PHONG
GROUP BY DA.TENDA
--37
SELECT MADA
FROM DEAN DA, PHANCONG PC, NHANVIEN NV
WHERE DA.MADA = PC.SODA AND PC.MA_NVIEN = NV.MANV AND NV.HONV = 'Dinh'
UNION
SELECT MADA
FROM DEAN DA, PHONGBAN PB, NHANVIEN NV
WHERE DA.PHONG = PB.MAPHG AND PB.TRPHG = NV.MANV AND NV.HONV = 'Dinh'
--38
SELECT  NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV AS HOTENNV , COUNT(TN.MA_NVIEN) AS SLTN
FROM NHANVIEN NV , THANNHAN TN
WHERE TN.MA_NVIEN=NV.MANV
GROUP BY NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV
HAVING COUNT(TN.MA_NVIEN)>=2
--39
SELECT  NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV AS HOTENNV
FROM NHANVIEN NV
WHERE NV.MANV NOT IN(
	 SELECT TN.MA_NVIEN
	 FROM THANNHAN TN
)
--40
SELECT TP.HONV+' '+ TP.TENLOT+' '+TP.TENNV AS HOTENTRPHG 
FROM NHANVIEN TP,PHONGBAN PB
WHERE PB.TRPHG = TP.MANV AND TP.MANV IN(
											SELECT MA_NVIEN 
											FROM THANNHAN
										)
--41
SELECT TP.HONV
FROM NHANVIEN TP,PHONGBAN PB
WHERE PB.TRPHG = TP.MANV AND TP.MANV NOT IN(
											SELECT MA_NVIEN 
											FROM THANNHAN
										)
--42
SELECT NV.HONV+' '+ NV.TENLOT+' '+NV.TENNV AS HOTENNV
FROM NHANVIEN NV,PHONGBAN PB
WHERE NV.PHG=PB.MAPHG AND LUONG > (SELECT AVG(LUONG) FROM NHANVIEN NV,PHONGBAN PB WHERE NV.PHG=PB.MAPHG AND PB.TENPHG='NGHIEN CUU')
--43
SELECT DEMNV.MAPHG, HONV+' '+TENLOT+' '+TENNV AS HOTENTRPHG
FROM NHANVIEN,PHONGBAN PB,
(
	SELECT MAPHG,TENPHG, COUNT(*) AS SONV
	FROM NHANVIEN NV,PHONGBAN PB
	WHERE MAPHG=PHG
	GROUP BY MAPHG,TENPHG
) AS DEMNV
WHERE PB.TRPHG=MANV AND DEMNV.SONV>=ALL(
	SELECT MAX(DEMNV.SONV)
	FROM (
	SELECT MAPHG, COUNT(*) AS SONV
	FROM NHANVIEN,PHONGBAN 
	WHERE MAPHG=PHG
	GROUP BY MAPHG) AS DEMNV
)


